<!DOCTYPE html>
<html>

<head>
    <!-- <script src="https://docs.opencv.org/4.x/opencv.js" type="text/javascript"></script> -->
    <!-- <script async src="https://docs.opencv.org/4.5.4/opencv.js" type="text/javascript"></script> -->
</head>

<body>
    <div style="border: thin solid black;">

        <center>
            <h2>OpenCV.js Magic box :)</h2>
            <p id="status">OpenCV.js status: Loading...</p>
            <div>
                <div class="row-align">
                    <video id="videoInput"></video>
                    <canvas id="canvasFrame" width="640" height="480"></canvas>
                    <canvas id="canvasOutput" width="640" height="480"></canvas>
                </div>

            </div>
        </center>

        <script type="text/javascript">
            function openCvReady() {
                cv['onRuntimeInitialized'] = () => {
                    let video = document.getElementById('videoInput');
                    let src = new cv.Mat(video.videoHeight, video.videoWidth, cv.CV_8UC4);
                    let dst = new cv.Mat(video.videoHeight, video.videoWidth, cv.CV_8UC1);
                    let cap = new cv.VideoCapture(video);

                    const FPS = 30;
                    function processVideo() {
                        try {

                            let begin = Date.now();
                            // start processing.
                            cap.read(src);
                            cv.cvtColor(src, dst, cv.COLOR_RGBA2GRAY);
                            cv.imshow('canvasOutput', dst);
                            // schedule the next one.
                            let delay = 1000 / FPS - (Date.now() - begin);
                            setTimeout(processVideo, delay);
                        } catch (err) {
                            console.log(err)
                        }
                    };

                    // schedule the first one.
                    setTimeout(processVideo, 0);
                };
            }
        </script>

        <script async src="https://docs.opencv.org/4.5.4/opencv.js" onload="openCvReady();"
            type="text/javascript"></script>
    </div>

</body>

</html>